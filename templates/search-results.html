<!DOCTYPE html>
<html class="wide wow-animation" lang="en">
<head>
    <title>Search Results</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
{#    <meta http-equiv="X-UA-Compatible" content="IE=edge">#}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!--    <link rel="icon" href="images/favicon.ico" type="image/x-icon">-->
<!--    <link rel="stylesheet" type="text/css"-->
<!--          href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700%7CKalam:300,400,700">-->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fonts.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" id="main-styles-link">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vanilla-select.min.css') }}">
    <style>.ie-panel {
        display: none;
        background: #212121;
        padding: 10px 0;
        box-shadow: 3px 3px 5px 0 rgba(0, 0, 0, .3);
        clear: both;
        text-align: center;
        position: relative;
        z-index: 1;
    }

    html.ie-10 .ie-panel, html.lt-ie-10 .ie-panel {
        display: block;
    }</style>
    <style>
        .ie-panel {
            display: none;
            background: #212121;
            padding: 10px 0;
            box-shadow: 3px 3px 5px 0 rgba(0, 0, 0, .3);
            clear: both;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        html.ie-10 .ie-panel, html.lt-ie-10 .ie-panel {
            display: block;
        }

        .select__arrow {
            display: none
        }

        .select__toolbox {
            border: none;
        }

    </style>
      <style>
    /* 遮罩层 */
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8); /* 黑色半透明 */
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    /* 弹窗内容 */
    #popup {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 90%;
      max-height: 80%;
      overflow: auto;
      width: 90%;
      height: 80%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid #333;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
        /* 地图容器 */
    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
<div class="preloader">
    <div class="preloader-body">
        <div class="cssload-bell">
            <div class="cssload-circle">
                <div class="cssload-inner"></div>
            </div>
            <div class="cssload-circle">
                <div class="cssload-inner"></div>
            </div>
            <div class="cssload-circle">
                <div class="cssload-inner"></div>
            </div>
            <div class="cssload-circle">
                <div class="cssload-inner"></div>
            </div>
            <div class="cssload-circle">
                <div class="cssload-inner"></div>
            </div>
        </div>
    </div>
</div>
<div class="page">
    <!-- Search results-->
    <section class="section section-sm section-first bg-default">
        <div class="container">
{#            <h2 class="font-weight-regular">#1 Select Histories</h2>#}
            <h3 class="font-weight-regular">#1 Select several POIs that you like</h3>
            <div class="row justify-content-center">
                <div class="col-lg-10 col-xl-9">
                    <!-- RD Search-->
                    <form class="rd-form rd-search rd-form-inline">
                        <div class="form-wrap">
                            <div ref="select" class="form-input select-box">
                                <div class="select__box ">
                                    <div ref="toolbox" class="select__toolbox">
                                        <div class="select__label">Select Items</div>
                                    </div>
                                    <div ref="dropdown" class="select__dropdown "><input ref="query" type="text"
                                                                                         value="ur"
                                                                                         class="select__query">
                                        <ul ref="list" class="select__list">
                                            <!--                        <li class="select__item" data-index="0" data-value="Allura">-->
                                            <!--                          <span class="select__item_text">Allura</span>-->
                                            <!--                        </li>-->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <!--              <div class="rd-search-results"></div>-->
                </div>
            </div>

            <br>
            <br>
            <form id="dynamic-form">
            <div class="row row-30 box-ordered"   id="selected-results">
<!--                                <div class="col-sm-6 col-lg-3">-->
<!--                                    <article class="box-icon-modern box-classic-mode">-->
<!--                                        <div class="box-icon-modern-header">-->
<!--                                            <div class="box-icon-modern-count box-ordered-item"></div>-->
<!--                                        </div>-->
<!--                                        <h4 class="box-icon-modern-title"><a href="#">Best Service</a></h4>-->
<!--                                        <p class="box-icon-modern-text text-gray-600">Est placerat in egestas erat imperdiet. Lorem ipsum dolor sit amet consectetur adipiscing.</p>-->
<!--                                    </article>-->
<!--                                </div>-->
<!--                                <div class="col-sm-6 col-lg-3">-->
<!--                                    <article class="box-icon-modern box-classic-mode">-->
<!--                                        <div class="box-icon-modern-header">-->
<!--                                            <div class="box-icon-modern-count box-ordered-item"></div>-->
<!--                                        </div>-->
<!--                                        <h4 class="box-icon-modern-title"><a href="#">Best Service</a></h4>-->
<!--                                        <p class="box-icon-modern-text text-gray-600">Est placerat in egestas erat imperdiet. Lorem ipsum dolor sit amet consectetur adipiscing.</p>-->
<!--                                    </article>-->
<!--                                </div>-->
            </div>
            <br>
            <br>
            <div class="form-button">
                <button class="button button-primary" type="submit">Recommend</button>
            </div>
            </form>
            <div class="row row-30 box-ordered rd-form-inline form-wrap">
            </div>
            <br>
            <br>
            <h3 class="font-weight-regular">#2 Recommended Items according to your favor</h3>
            <div class="row row-30 box-ordered" id="searched-results">

                <!--            <div class="col-sm-6 col-lg-3">-->
                <!--              <article class="box-icon-modern box-classic-mode">-->
                <!--                <div class="box-icon-modern-header">-->
                <!--                  <div class="box-icon-modern-count box-ordered-item"></div>-->
                <!--                </div>-->
                <!--                <h4 class="box-icon-modern-title"><a href="#">Reputation</a></h4>-->
                <!--                <p class="box-icon-modern-text text-gray-600">Non curabitur gravida arcu ac tortor dignissim. Sapien faucibus et molestie ac feugiat . </p>-->
                <!--              </article>-->
                <!--            </div>-->
                <!--            <div class="col-sm-6 col-lg-3">-->
                <!--              <article class="box-icon-modern box-classic-mode">-->
                <!--                <div class="box-icon-modern-header">-->
                <!--                  <div class="box-icon-modern-count box-ordered-item"></div>-->
                <!--                </div>-->
                <!--                <h4 class="box-icon-modern-title"><a href="#">Safety</a></h4>-->
                <!--                <p class="box-icon-modern-text text-gray-600">Dolor sed viverra ipsum nunc aliquet. Integer malesuada nunc vel risus commodo viverra .</p>-->
                <!--              </article>-->
                <!--            </div>-->
                <!--            <div class="col-sm-6 col-lg-3">-->
                <!--              <article class="box-icon-modern box-classic-mode">-->
                <!--                <div class="box-icon-modern-header">-->
                <!--                  <div class="box-icon-modern-count box-ordered-item"></div>-->
                <!--                </div>-->
                <!--                <h4 class="box-icon-modern-title"><a href="#">Security</a></h4>-->
                <!--                <p class="box-icon-modern-text text-gray-600">Pulvinar etiam non quam lacus suspendisse. Sed arcu non odio euismod lacinia at quis  .</p>-->
                <!--              </article>-->
                <!--            </div>-->
            </div>
        </div>
    </section>
{#    <button onclick="showPopup()">显示表格弹窗</button>#}
</div>
<div class="snackbars" id="form-output-global"></div>



<!-- 弹窗 -->
<!-- 弹窗和遮罩层 -->
<div id="overlay" onclick="hidePopup()">
  <div id="popup" onclick="event.stopPropagation()">
      <div id="map"></div>
{#    <table>#}
{#      <thead>#}
{#        <tr><th>姓名</th><th>年龄</th><th>城市</th></tr>#}
{#      </thead>#}
{#      <tbody>#}
{#        <tr><td>张三</td><td>25</td><td>北京</td></tr>#}
{#        <tr><td>李四</td><td>30</td><td>上海</td></tr>#}
{#        <tr><td>王五</td><td>28</td><td>广州</td></tr>#}
{#      </tbody>#}
{#    </table>#}
  </div>
</div>

<script src="{{ url_for('static', filename='js/core.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script src="{{ url_for('static', filename='js/vanilla-select.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/items.js') }}"></script>
<script>
    function removeThisDiv(element) {
        // 获取父级 div
        var parentDiv = element.closest('.col-sm-6');

        // 删除父级 div
        if (parentDiv) {
            parentDiv.remove();
        }
    }

    let map_ = {};
    {#console.log(source[0])#}
    for (let i = 0; i < source.length; i++) {
        item = source[i];
        map_[item['id']] = item;
        source[i]['value'] = item['value']; // + ' (' + item['categories'] + ')';
    }

    let select = Array.from(document.querySelectorAll('[ref="select"]')).map(el => {
        return new Select({
            placeholder: 'Select Items Here',
            search: true,
            noResults: 'No results found',
            dataset: source,
            itemmap: map_,
            onSelected: item => {
                // AJAX 请求
            fetch("/item", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(item),
            })
                .then((response) => response.json())
                .then((result) => {
                    if ('item' in result){
                        item = result.item
                        // console.log(item)
                        container = document.querySelector('#selected-results')
                        let str = '       <div class="col-sm-6 col-lg-3">\n' +
                            '               <article class="box-icon-modern box-classic-mode">\n' +
                            '                <!-- <div class="box-icon-modern-header">\n' +
                            '                  <div class="box-icon-modern-count box-ordered-item"></div> &nbsp;&nbsp;&nbsp;&nbsp;<p style="color: #FF0000" onclick="removeThisDiv(this)">X</p>\n' +
                            '                </div>\n-->' +
                            '                <h4 class="box-icon-modern-title"><a href="#">' + item['value'] + '</a> <b style="color: #FF0000; cursor: pointer" onclick="removeThisDiv(this)">X</b></h4>\n' +
                            '                <p class="box-icon-modern-text">' + item['categories'] + '</p>\n' +
                            '               </article>\n' +
                            '               <input type="hidden" value="' + item['id'] + '" name="array[]">'
                            '            </div>';
                        container.insertAdjacentHTML('beforeend', str);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                });
            }
        }).componentMount({
            el: el
        });
    });

    const form = document.getElementById("dynamic-form");
    form.addEventListener("submit", (event) => {
            event.preventDefault(); // 防止默认提交

            // 使用 FormData 收集表单数据
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                if (!data[key]) {
                    data[key] = [];
                }
                data[key].push(value);
            });

            {#console.log(data)#}

            // AJAX 请求
            fetch("/submit", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
            })
                .then((response) => response.json())
                .then((result) => {
                    if ('array' in result){

                    container = document.querySelector('#searched-results')
                    container.innerHTML = ''
                    {#console.log("result:", result);#}
                    {#console.log("result array:", result['array']);#}
                    items = result['array']
                    {#for (const item_id of items){#}
                    for (const item of items){
                        {#item = map_[item_id]#}
                        let str = '       <div class="col-sm-6 col-lg-3" onclick="showPopup(\''+item['value']+'\','+item['latitude']+','+item['longitude']+')">\n' +
                            '               <article class="box-icon-modern box-classic-mode">\n' +
                            '               <div class="box-icon-modern-header"> <div class="box-icon-modern-count box-ordered-item"></div> </div> ' +
                            '                <!-- <div class="box-icon-modern-header">\n' +
                            '                  <div class="box-icon-modern-count box-ordered-item"></div> &nbsp;&nbsp;&nbsp;&nbsp;<p style="color: #FF0000" onclick="removeThisDiv(this)">X</p>\n' +
                            '                </div>\n-->' +
                            '                <h4 class="box-icon-modern-title"><a href="javascript:void(0)" >' + item['value'] + '</a></h4>\n' +
                            '                <p class="box-icon-modern-text">' + item['categories'] + '</p>\n' +
                            '               </article>\n' +
                            '            </div>';
                        container.insertAdjacentHTML('beforeend', str);
                    }
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                });
        });


    // let select2 = new Select({
    //   dataset: source,
    //   selected: source[1].value,
    //   onSelected: item => console.log(item)
    // }).componentMount({
    //   el: document.querySelector('[ref="select2"]')
    // });


</script>


<script>
mapInitialized = false
map = null;
function showPopup(name, latitude, longitude) {
  document.getElementById('overlay').style.display = 'flex';
  {#document.getElementById('overlay').insertAdjacentHTML('beforeend', latitude + longitude);#}
  {#  if (!mapInitialized) {#}
    map = new BMapGL.Map("map"); // 创建地图实例
    {#mapInitialized = true;#}
        // 自定义地图样式：隐藏地名label
    map.setMapStyleV2({
      styleJson: [
        {
          featureType: "all",
          elementType: "labels",
          stylers: {
            visibility: "off"
          }
        }
      ]
    });
    //}

    const point = new BMapGL.Point(longitude, latitude); // 经纬度是 (lng, lat)，注意顺序

    // 添加标注
    const marker = new BMapGL.Marker(point);

    map.addOverlay(marker);
    const label = new BMapGL.Label(name, {
        position: point,
        offset: new BMapGL.Size(30, -30)
    });

    label.setStyle({
      color: "#fff",
      backgroundColor: "#000",
      border: "none",
      fontSize: "14px",
      padding: "2px 4px",
      borderRadius: "3px"
    });
    marker.setLabel(label);

    map.centerAndZoom(point, 15); // 初始化地图，设置中心点坐标和缩放级别
    map.enableScrollWheelZoom(true); // 开启鼠标滚轮缩放
}

function hidePopup() {
  document.getElementById('overlay').style.display = 'none';
}
</script>
<script src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=JXSyTxHA9W8SkhlbAavzLuu6R6uQdCJi"></script>
</body>
</html>
